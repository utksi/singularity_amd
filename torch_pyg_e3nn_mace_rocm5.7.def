Bootstrap: docker
From: rocm/dev-ubuntu-22.04:5.7-complete

%post
    # Set DNS for internet access during the build process
    echo "nameserver 8.8.8.8" > /etc/resolv.conf
    echo "nameserver 8.8.4.4" >> /etc/resolv.conf

    # Update the package repository and install necessary packages
    apt-get update -y
    apt-get install -y software-properties-common
    add-apt-repository universe
    add-apt-repository main
    apt-get update -y
    apt-get install -y build-essential git vim curl wget zip unzip zlib1g-dev pkg-config libblas-dev liblapack-dev python3-dev python3-venv python3-pip python3-wheel graphviz libhdf5-dev python3-distutils libjpeg-dev iputils-ping swig
    apt-get clean

    # Create a symlink for python as some software still expects `python` binary
    ln -s /usr/bin/python3 /usr/bin/python

    # Upgrade pip
    python3 -m pip install --upgrade pip
    python3 -m pip cache purge

    # Install PyTorch and other dependencies without using the pip cache
    python3 -m pip --no-cache-dir install torch==2.2.2 torchvision==0.17.2 torchaudio==2.2.2 --index-url https://download.pytorch.org/whl/rocm5.7
    
    # Additional PyTorch libraries and dependencies
    mkdir bin && cd bin
    git clone https://github.com/greg7mdp/parallel-hashmap.git
    git clone https://github.com/Looong01/pyg-rocm-build.git && cd pyg-rocm-build
    cd ./pytorch_cluster-1.6.3 && pip install . && cd ../
    cd ./pytorch_scatter-2.1.2 && pip install . && cd ../
    cd ./pytorch_sparse-0.6.18 && sed -i 's|phmap_dir = osp.abspath("third_party/parallel-hashmap")|phmap_dir = osp.abspath("/root/bin/parallel-hashmap/parallel_hashmap")|' setup.py && pip install . && cd ../
    cd ./pytorch_spline_conv-1.2.2 && pip install . && cd ../
    cd ./pytorch_geometric-2.5.2 && pip install . && cd $HOME
    
    # Additional Python packages
    python3 -m pip --no-cache-dir install mace-torch numba gitpython pytest pytest-cov blackcellmagic graphviz gpustat h5py jupyterlab

%environment
    # singulrity binds the system nameserver to its shell everytime
    # unless explicitly turned off
    export SHELL=/bin/bash

%runscript
    exec "$@"

